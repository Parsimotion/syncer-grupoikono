JsonStreamReader = require("./jsonStreamReader")
WoowJsonAdapter = require("./woowJsonAdapter")
_ = require("lodash")
path = require("path")
fs = require("fs")
nock = require("nock")
Promise = require("bluebird")

clean = (collection) -> collection.map (o) -> _.omit o, _.isFunction

describe 'WoowJsonAdapter', ->
  adjustments = []

  beforeEach ->
    filename = path.join __dirname, 'woow.json'
    domain = 'https://imagesproducteca.blob.core.windows.net'
    url = '/jsons/woow.json'
    json = fs.readFileSync filename

    nock(domain).get(url).reply 200, json

    adjustments = []
    options =
      url: domain + url

    adapter = new WoowJsonAdapter()
    new JsonStreamReader().read options, (item) ->
      Promise.resolve adjustments = adjustments.concat adapter.adapt item

  it 'can adapt a json to a product', ->
    expected =
      [
        code: "132934"
        brand: "woOw"
        category: "Toallas"
        name: "Toalla de microfibra de rápido secado color blanca"
        description: "Toalla de microfibra de rápido secado color blanca"
        identifier: "CJTX1110562"
        stocks: [{ warehouse: "Default", quantity: 420 }]
        prices: [{ priceList: "Default", value: 250 }]
        partNumber: "http://www.woow.com.uy/frontend/buy/index/132934/1?utm_campaign=ML_Sale&utm_source=MercadoLibre&utm_term=132934&utm_medium=satellite"
        pictures: [ url: "https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/e0/0e/e00e7c26ed586693507729504d585f27_630x315.jpg" ]
        notes: "<div class=\"container_12 title_block grey_border rounded_corners margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; height: 110px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #d9dadc;\">\n    <div class=\"grid_12\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 98.0%;\">\n        <p class=\"text_code\" style=\"font-size: 10px; color: #999; margin: 4px 0 0 0; text-align: right;\">COD: 132934</p>\n        <h1 style=\"text-align: center; font-size: 40px; margin: 23px 0 0 0;\">Toalla de microfibra de rápido secado color blanca</h1>\n    </div>\n    <div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n</div>\n<div class=\"container_12 content_block margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px;\">\n    <div class=\"grid_6 image_block\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 48.0%;\"><img src=\"https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/e0/0e/e00e7c26ed586693507729504d585f27_630x315.jpg\" alt=\"Imagen de producto\" width=\"100%\" />\n    </div>\n    <div class=\"grid_6 description_block\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 48.0%;\">\n        <h1 style=\"text-align: left; margin: 17px 0 0px 40px; font-size: 25px; letter-spacing: 0.7px;;\">PRECIO: $ 250</h1>\n        <h1 style=\"text-align: left; margin: 17px 0 0px 40px; font-size: 25px; letter-spacing: 0.7px; color: #025496;\"></h1>\n        <h2 style=\"text-align: left; margin: 0px 0px 30px 40px; font-size: 16px; letter-spacing: 0.7px; color: #025496;\"><br/>DESCRIPCI&Oacute;N DE LA PUBLICACI&Oacute;N:</h2>     <b>Absorbe mucho más que las toallas comunes</b><br/><b>Peso: </b>260g.<br/><b>Medida:</b> 140 cm. x 70 cm.<br/><b>Disponible en:</b><br/>- Azul<br/><b>Composición: </b>100% polyester.<br/>\n    </br></br>Toalla de microfibra, tendencia en los últimos años!<br/>¿Por qué? La toalla de microfibra requiere poco espacio físico para guardarse. <br/>A su vez, es especialmente útil para su transporte y uso fuera del ámbito doméstico.<br/>Su absorción es óptima y seca más que el algodón.<br/>Ideal para llevar al gimnasio, la piscina, o al camping!<br/>El principal secreto de ese tipo de toallas es su composición, las fibras son casi tres veces menores a las convencionales que componen las toallas de algodón.<br/>Tienen una gran resistencia a los lavados frecuentes y no quedan acartonadas.<br/>No se arrugan.<br/><span> <b>Importante:</b> a la hora del lavado se aconseja separar las prendas blancas de las de color. Este producto podría desteñir en sus primeros lavados</span><br/>\n    </div>\n    <div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n</div>\n<div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n<div class=\"container_12 atention_block orange_bg orange_border rounded_corners margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #f89f1d; background: #f89f1d;\">\n    <div class=\"content\" style=\"font-family: Arial; color: #fff; padding: 15px 25px;\">\n        <table style=\"width: 100%;\">\n            <tbody>\n                <tr>\n                    <td style=\"font-size: 19px; letter-spacing: 0.4px; font-weight: bold;\"><img src=\"http://a03c5e2e3ebd1e46d96f-16c9a80647c59aa386db9fc9784890ec.r92.cf2.rackcdn.com/exclamacion.png\" alt=\"ATENCI&Oacute;N!\" />\n                    </td>\n                    <td style=\"font-size: 17px; letter-spacing: 0.4px; font-weight: bold;\"><span class=\"white_text\" style=\"color: #FFFFFF;\">PRECIO Y STOCK GARANTIZADO SOLO POR HOY!</span>\n                        </br>Al realizar la compra, <span class=\"yellow_text\" style=\"color: #ffea00;\">TE ENVIAREMOS UN MAIL AUTOM&Aacute;TICO CON INSTRUCCIONES</span> para\n                        <br /> que puedas seleccionar la <span style=\"text-decoration: underline;\">forma de pago y opci&oacute;n de entrega.</br>Tu compra es un compromiso.</span>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n</div>\n<div style=\"height: 274px;\"></div>\n<div class=\"container_12 delivery_block grey_border rounded_corners margin_bottom_20\" style=\"background-color:#6f8b25; font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #6f8b25; position: absolute; bottom: 701px;\"><div class=\"content\" style=\"font-family: Arial; color: #444444; padding-left: 20px; padding-right: 20px;\">\n        <h2 style=\"text-align: left; font-size: 16px; margin: 17px 0 0 0; letter-spacing: 0.7px; color: #fff;\"></h2>\n        <br/>\n        <center>\n            <img src=\"http://a03c5e2e3ebd1e46d96f-16c9a80647c59aa386db9fc9784890ec.r92.cf2.rackcdn.com/entregas.png\" alt=\"woOw Uruguay\" />\n        </center>\n        <p class=\"muted\" style=\"color: #fff; font-size: 12px;\">\n            La fecha de entrega prometida es pagando hoy para retirar un nuestro pickup center de pocitos, la misma puede variar según fecha de pago y punto de retiro seleccionado.\n            <br>\n            Algunas formas de entrega pueden tener costo extra, podrás consultar los mismos al momento de elegir el lugar siguiendo las instrucciones que te enviamos por correo electrónico inmediatamente después de realizada la compra en Mercado Libre.\n            <br>\n            Atención: sólo se entregan productos, no se realizan ventas en el lugar.\n        </p>\n    </div>\n</div>"
      ,
        code: "132945"
        brand: "woOw"
        category: "Iluminación"
        name: "Lámpara de suspensión blanco"
        description: "Lámpara de suspensión blanco"
        identifier: "CJXX1111124"
        stocks: [{ warehouse: "Default", quantity: 0 }]
        prices: [{ priceList: "Default", value: 1660 }]
        partNumber: "http://www.woow.com.uy/frontend/buy/index/132945/1?utm_campaign=ML_Sale&utm_source=MercadoLibre&utm_term=132945&utm_medium=satellite"
        pictures: [ url: "https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/d2/25/d22592fc5b9c5b02593d242c155edea9_630x315.jpg" ]
        notes: "<div class=\"container_12 title_block grey_border rounded_corners margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; height: 110px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #d9dadc;\">\n    <div class=\"grid_12\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 98.0%;\">\n        <p class=\"text_code\" style=\"font-size: 10px; color: #999; margin: 4px 0 0 0; text-align: right;\">COD: 132945</p>\n        <h1 style=\"text-align: center; font-size: 40px; margin: 23px 0 0 0;\">Lámpara de suspensión blanco</h1>\n    </div>\n    <div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n</div>\n<div class=\"container_12 content_block margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px;\">\n    <div class=\"grid_6 image_block\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 48.0%;\"><img src=\"https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/d2/25/d22592fc5b9c5b02593d242c155edea9_630x315.jpg\" alt=\"Imagen de producto\" width=\"100%\" />\n    </div>\n    <div class=\"grid_6 description_block\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 48.0%;\">\n        <h1 style=\"text-align: left; margin: 17px 0 0px 40px; font-size: 25px; letter-spacing: 0.7px;;\">PRECIO: $ 1.660</h1>\n        <h1 style=\"text-align: left; margin: 17px 0 0px 40px; font-size: 25px; letter-spacing: 0.7px; color: #025496;\">PAGANDO CON OCA: $1.560</h1>\n        <h2 style=\"text-align: left; margin: 0px 0px 30px 40px; font-size: 16px; letter-spacing: 0.7px; color: #025496;\"><br/>DESCRIPCI&Oacute;N DE LA PUBLICACI&Oacute;N:</h2>     Medidas tulipa: 15 x 17 cm. - Tulipa simil mimbre\n    </br></br><ul><li><b>Lámpara de suspensión rústica.</b><br/></li><li>Materiales delicados y elegantes.</li><li>Detalles:</li><li>Tres plafones en forma de tulipa con entramado símil mimbre.</li><li>Interior: vidrio blanco.</li><li>Medidas tulipa: 17 x 15 cm.</li><li><b>Colores disponibles:</b></li><li>Marrón.</li><li>Blanco.</li><li>Alturas regulables a gusto.</li><li>¡Ideas..!</li><li>Baja: Colgala sobre una mesa de comedor.</li><li>Larga: vestí tu living creando un ambiente cálido y elegante.</li><li><b>La lámpara se entrega desarmada.</b></li><li>La imagen es ilustrativa. Algunos detalles del producto pueden diferir de la imagen<br/></li></ul>\n    </div>\n    <div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n</div>\n<div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n<div class=\"container_12 atention_block orange_bg orange_border rounded_corners margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #f89f1d; background: #f89f1d;\">\n    <div class=\"content\" style=\"font-family: Arial; color: #fff; padding: 15px 25px;\">\n        <table style=\"width: 100%;\">\n            <tbody>\n                <tr>\n                    <td style=\"font-size: 19px; letter-spacing: 0.4px; font-weight: bold;\"><img src=\"http://a03c5e2e3ebd1e46d96f-16c9a80647c59aa386db9fc9784890ec.r92.cf2.rackcdn.com/exclamacion.png\" alt=\"ATENCI&Oacute;N!\" />\n                    </td>\n                    <td style=\"font-size: 17px; letter-spacing: 0.4px; font-weight: bold;\"><span class=\"white_text\" style=\"color: #FFFFFF;\">PRECIO Y STOCK GARANTIZADO SOLO POR HOY!</span>\n                        </br>Al realizar la compra, <span class=\"yellow_text\" style=\"color: #ffea00;\">TE ENVIAREMOS UN MAIL AUTOM&Aacute;TICO CON INSTRUCCIONES</span> para\n                        <br /> que puedas seleccionar la <span style=\"text-decoration: underline;\">forma de pago y opci&oacute;n de entrega.</br>Tu compra es un compromiso.</span>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n</div>\n<div style=\"height: 274px;\"></div>\n<div class=\"container_12 delivery_block grey_border rounded_corners margin_bottom_20\" style=\"background-color:#6f8b25; font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #6f8b25; position: absolute; bottom: 701px;\"><div class=\"content\" style=\"font-family: Arial; color: #444444; padding-left: 20px; padding-right: 20px;\">\n        <h2 style=\"text-align: left; font-size: 16px; margin: 17px 0 0 0; letter-spacing: 0.7px; color: #fff;\"></h2>\n        <br/>\n        <center>\n            <img src=\"http://a03c5e2e3ebd1e46d96f-16c9a80647c59aa386db9fc9784890ec.r92.cf2.rackcdn.com/entregas.png\" alt=\"woOw Uruguay\" />\n        </center>\n        <p class=\"muted\" style=\"color: #fff; font-size: 12px;\">\n            La fecha de entrega prometida es pagando hoy para retirar un nuestro pickup center de pocitos, la misma puede variar según fecha de pago y punto de retiro seleccionado.\n            <br>\n            Algunas formas de entrega pueden tener costo extra, podrás consultar los mismos al momento de elegir el lugar siguiendo las instrucciones que te enviamos por correo electrónico inmediatamente después de realizada la compra en Mercado Libre.\n            <br>\n            Atención: sólo se entregan productos, no se realizan ventas en el lugar.\n        </p>\n    </div>\n</div>"
      ,
        code: "135603"
        brand: "woOw"
        category: "Ferretería"
        name: "Destornillador a batería con 6 puntas"
        description: "Destornillador a batería con 6 puntas"
        identifier: "CJXX1111129"
        stocks: [{ warehouse: "Default", quantity: 0 }]
        prices: [{ priceList: "Default", value: 890 }]
        partNumber: "http://www.woow.com.uy/frontend/buy/index/135603/1?utm_campaign=ML_Sale&utm_source=MercadoLibre&utm_term=135603&utm_medium=satellite"
        pictures: [
          url: "https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/11/ab/11abb4ca848020238cd5464c76515ee7_630x315.jpg"
        ,
          url: "https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/8b/f4/8bf480fefc6e42f7dea5e59cec7ef19d_630x315.jpg"
        ,
          url: "https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/5c/e9/5ce9f675789e5c602d11f6000634e1bc_630x315.jpg"
         ]
        notes: "<div class=\"container_12 title_block grey_border rounded_corners margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; height: 110px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #d9dadc;\">\n    <div class=\"grid_12\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 98.0%;\">\n        <p class=\"text_code\" style=\"font-size: 10px; color: #999; margin: 4px 0 0 0; text-align: right;\">COD: 135603</p>\n        <h1 style=\"text-align: center; font-size: 40px; margin: 23px 0 0 0;\">Destornillador a batería con 6 puntas</h1>\n    </div>\n    <div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n</div>\n<div class=\"container_12 content_block margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px;\">\n    <div class=\"grid_6 image_block\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 48.0%;\"><img src=\"https://68b70847b87fa4ca414b-2a9b9aa40f6a1fb4934d31fcacd61214.ssl.cf2.rackcdn.com/11/ab/11abb4ca848020238cd5464c76515ee7_630x315.jpg\" alt=\"Imagen de producto\" width=\"100%\" />\n    </div>\n    <div class=\"grid_6 description_block\" style=\"font-family: Arial; color: #444444; display: inline; float: left; position: relative; margin-left: 1%; margin-right: 1%; width: 48.0%;\">\n        <h1 style=\"text-align: left; margin: 17px 0 0px 40px; font-size: 25px; letter-spacing: 0.7px;;\">PRECIO: $ 890</h1>\n        <h1 style=\"text-align: left; margin: 17px 0 0px 40px; font-size: 25px; letter-spacing: 0.7px; color: #025496;\">undefined</h1>\n        <h2 style=\"text-align: left; margin: 0px 0px 30px 40px; font-size: 16px; letter-spacing: 0.7px; color: #025496;\"><br/>DESCRIPCI&Oacute;N DE LA PUBLICACI&Oacute;N:</h2>     <ul><li>Diseño ergonómico, en materiales antideslizantes.</li><li>Con posición para llegar a los lugares más difíciles</li></ul>\n    </br></br><ul><li><b>Destornillador a batería con 6 puntas.</b></li><li>6 puntas incorporadas en el mismo destornillador.</li><li>Posición para atornillar y destornillar.</li><li>Luz led asistente.</li><li>Funciona a batería. (Incluye cargador).</li><li>Puedes utilizarlo a 90° o a casi 180° girando el mango.<br/></li></ul>\n    </div>\n    <div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n</div>\n<div class=\"clear\" style=\"font-family: Arial; color: #444444; clear: both; display: block; overflow: hidden; visibility: hidden; width: 0; height: 0;\"></div>\n<div class=\"container_12 atention_block orange_bg orange_border rounded_corners margin_bottom_20\" style=\"font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #f89f1d; background: #f89f1d;\">\n    <div class=\"content\" style=\"font-family: Arial; color: #fff; padding: 15px 25px;\">\n        <table style=\"width: 100%;\">\n            <tbody>\n                <tr>\n                    <td style=\"font-size: 19px; letter-spacing: 0.4px; font-weight: bold;\"><img src=\"http://a03c5e2e3ebd1e46d96f-16c9a80647c59aa386db9fc9784890ec.r92.cf2.rackcdn.com/exclamacion.png\" alt=\"ATENCI&Oacute;N!\" />\n                    </td>\n                    <td style=\"font-size: 17px; letter-spacing: 0.4px; font-weight: bold;\"><span class=\"white_text\" style=\"color: #FFFFFF;\">PRECIO Y STOCK GARANTIZADO SOLO POR HOY!</span>\n                        </br>Al realizar la compra, <span class=\"yellow_text\" style=\"color: #ffea00;\">TE ENVIAREMOS UN MAIL AUTOM&Aacute;TICO CON INSTRUCCIONES</span> para\n                        <br /> que puedas seleccionar la <span style=\"text-decoration: underline;\">forma de pago y opci&oacute;n de entrega.</br>Tu compra es un compromiso.</span>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n</div>\n<div style=\"height: 274px;\"></div>\n<div class=\"container_12 delivery_block grey_border rounded_corners margin_bottom_20\" style=\"background-color:#6f8b25; font-family: Arial; color: #444444; width: 92%; margin-left: 4%; margin-right: 4%; margin-bottom: 20px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; border: 2px solid #6f8b25; position: absolute; bottom: 701px;\"><div class=\"content\" style=\"font-family: Arial; color: #444444; padding-left: 20px; padding-right: 20px;\">\n        <h2 style=\"text-align: left; font-size: 16px; margin: 17px 0 0 0; letter-spacing: 0.7px; color: #fff;\"></h2>\n        <br/>\n        <center>\n            <img src=\"http://a03c5e2e3ebd1e46d96f-16c9a80647c59aa386db9fc9784890ec.r92.cf2.rackcdn.com/entregas.png\" alt=\"woOw Uruguay\" />\n        </center>\n        <p class=\"muted\" style=\"color: #fff; font-size: 12px;\">\n            La fecha de entrega prometida es pagando hoy para retirar un nuestro pickup center de pocitos, la misma puede variar según fecha de pago y punto de retiro seleccionado.\n            <br>\n            Algunas formas de entrega pueden tener costo extra, podrás consultar los mismos al momento de elegir el lugar siguiendo las instrucciones que te enviamos por correo electrónico inmediatamente después de realizada la compra en Mercado Libre.\n            <br>\n            Atención: sólo se entregan productos, no se realizan ventas en el lugar.\n        </p>\n    </div>\n</div>"
       ]

    clean(adjustments).should.eql expected
